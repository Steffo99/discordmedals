{% extends "base.htm.j2" %}
{% block title %}{{ medal }} - Discord Medals{% endblock %}
{% block extrahead %}
    <script>
        function regenToken(medalid)
        {
            var token_element = document.getElementById("medal-" + medalid + "-token");
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if(request.readyState === 4 && request.status === 200)
                {
                    var data = JSON.parse(request.responseText);
                    if(data["success"])
                    {
                        token_element.innerHTML = data["new_token"]
                    }
                    else
                    {
                        alert("Error while regenerating the token")
                    }
                }
            };
            request.open("GET", "/api/regentoken?token=" + token_element.innerHTML.replace(/^\s+|\s+$/g, ''), true);
            request.send(null);
        }

        function awardMedal(medalid)
        {
            var token_element = document.getElementById("medal-" + medalid + "-token");
            var user = prompt("User ID:");
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if(request.readyState === 4 && request.status === 200)
                {
                    var data = JSON.parse(request.responseText);
                    if(data["success"])
                    {
                        location.reload();
                    }
                    else
                    {
                        alert("Error while awarding the medal")
                    }
                }
            };
            request.open("GET", "/api/awardmedal?token=" + token_element.innerHTML.replace(/^\s+|\s+$/g, '') + "&user=" + user, true);
            request.send(null);
        }
    </script>
{% endblock %}
{% block content %}
    <div class="panel panel-default medal">
        <div class="panel-body">
            <div class="media">
                <div class="media-left">
                    <span class="glyphicon glyphicon-{{ medal.icon }} {{ medal.tier }} medal-icon"></span>
                </div>
                <div class="media-body">
                    <h4 class="media-header medal-name">
                        {{ medal.name }}
                    </h4>
                    <div class="medal-description">
                        {{ medal.description }}
                    </div>
                    {% if medal.guild.owner_id == user.id %}
                        <div class="medal-token" id="medal-{{ medal.id }}-token">
                            {{ medal.token }}
                        </div>
                        <div class="medal-actions">
                            <a class="btn btn-primary" href="/medal/{{ medal.id }}/edit">Edit</a>
                            <a class="btn btn-danger" href="#" onclick="regenToken({{ medal.id }})">Regen</a>
                            <a class="btn btn-success" href="#" onclick="awardMedal({{ medal.id }})">Award</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% if awards %}
        <h2>
            Awards <span class="badge">{{ awards | length }}</span>
        </h2>
        <table class="table">
            <thead>
                <tr>
                    {% if medal.guild.owner_id == user.id %}
                        <th>ID</th>
                    {% endif %}
                    <th>User</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for award in awards %}
                    <tr>
                        {% if medal.guild.owner_id == user.id %}
                            <td><span class="darker small">{{ award.award_id }}</span></td>
                        {% endif %}
                        <td><a href="/user/{{ award.user.id }}"><img class="small-discord-avatar" src="{{ award.user.avatar_url() }}"> {{ award.user }}</a></td>
                        <td>{{ award.date }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        This medal has yet to be awarded to someone.
    {% endif %}
{% endblock %}